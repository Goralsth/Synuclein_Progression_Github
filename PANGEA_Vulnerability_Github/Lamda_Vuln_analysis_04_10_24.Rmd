---
title: "Pangea_Vuln_Analysis_04_10_24"
output: html_document
date: "2024-04-10"
---


Goal is to plot a scatterplot of FDR value and r value, and color by wether enriched in pSyn postive or pSyn negative in LAMDA


```{r}
library(ggplot2)
library(readr)
```





```{r}

total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson <- read_csv("total_pathAllGenesVulnerability_1.3.6.9.MPI_pearson.csv")


library(readr)
LAMDA_Signature_Mouse <- read_csv("LAMDA_Signature_Mouse.csv", 
    col_types = cols(...1 = col_skip()))
View(LAMDA_Signature_Mouse)
```


```{r}


library(readxl)

total_path_sig<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[which(total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$p_fdr<0.05),]

write.csv(total_path_sig,"total_path_sig.csv")


#After runnning GO in gprofiler. Pull down the gpofiler excel file results. Pull out Kinase activity genes, and create excel file with just those genes (E.g. present in correlation data and in the Kinase activity pathway)
Kinase_activity_positve_genes <- read_excel("Go_Kinase_Activity_Genes_Corr_PathVuln.xlsx", col_names = FALSE)

```






```{r}

#get genes in Neun and pSyn in correlation data
ind<-which(LAMDA_Signature_Mouse$FDR<0.05)

LAMDA_signif<-LAMDA_Signature_Mouse[ind,]

ind2<-which(abs(LAMDA_signif$Estimate)>0.5)

LAMDA_signif<-LAMDA_signif[ind2,]


LAMDA_genes_signif<-LAMDA_signif$Feature


total_path_genes<-total_path_sig$gene


lamda_ind<-LAMDA_genes_signif %in% total_path_genes 

LAMDA_signif[lamda_ind,]


ind_neun_genes<-which(LAMDA_signif$Estimate<0)


neun_genes<-LAMDA_signif$Feature[ind_neun_genes]

ind_psyn_genes<-which(LAMDA_signif$Estimate>0)

psyn_genes<-LAMDA_signif$Feature[ind_psyn_genes]

```


```{r}

#plot the scatter plot

library(ggplot2)

ann_colors<- list(
  segment= c(NeuN="steelblue1", pSyn="firebrick1"),
  Layer= c("0"="gray","5"="greenyellow","4"="orange3","2"="sandybrown"),
  Region= c(AUD="blue", BLAp="green",COA="sandybrown",ECT="orange",ENTl="brown", EPv="gray", PA="purple",PERI="pink", SNc="black", TEa="cyan", TR="magenta", VIS="violet"))


total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene_color<-"NS or FC < 0.5"
ind<-which(total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene%in%neun_genes)
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene_color[ind]<-"aggregate -"

ind<-which(total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene%in%psyn_genes)
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene_color[ind]<-"aggregate +"

  

p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r, y = -log10(p_fdr),color=gene_color), size=0.4,alpha=0.25) +
  theme_minimal() +
  theme(legend.position = "none")+
  scale_color_manual(values = c(`aggregate -` = "steelblue1",
                                `aggregate +` = "firebrick1",
                                  `NS or FC < 0.5` = "gray"))+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())


ggsave("scatter_totalpath_AllGenes_LAMDAsigonly.pdf", p,  width = 14, height = 15, units = "cm")


```




Lets look at estimate and correlation of the same genes

```{r}

library(ggrepel)

lamda1<-cbind(LAMDA_Signature_Mouse$Feature,LAMDA_Signature_Mouse$Estimate, LAMDA_Signature_Mouse$FDR)
lamda1<-as.data.frame(lamda1)
colnames(lamda1)<-c("gene","Estimate","lamFDR")
lamda1$Estimate<-as.numeric(lamda1$Estimate)
r_estimate<-merge(total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson,lamda1,by="gene")



r_estimate$sig_corr_color[r_estimate$p_fdr<0.05 & r_estimate$Estimate<(-0.5)& r_estimate$lamFDR<0.05]<-"significant NeuN"
r_estimate$sig_corr_color[r_estimate$p_fdr<0.05 & r_estimate$Estimate>0.5& r_estimate$lamFDR<0.05]<-"significant pSyn"
r_estimate$sig_corr_color[is.na(r_estimate$sig_corr_color)]<-"NS"

p<-ggplot(data = r_estimate)  +
  geom_point(aes(x = r, y = Estimate,color=sig_corr_color), size=0.4,alpha=0.45) +
  theme_minimal() +
  theme(legend.position = "none")+
   geom_hline(yintercept = c(0.5, -0.5), lty = "dashed", size=0.2) +
    geom_vline(xintercept = c(-0.2718778, 0.2718778), lty = "dashed", size=0.2) +
  scale_color_manual(values = c(`significant NeuN` = "steelblue1",
                                `significant pSyn` = "firebrick1",
                                  `NS` = "gray"))+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  geom_text_repel(data = subset(r_estimate, sig_corr_color!= "NS"), aes(x = r, y = Estimate,color=sig_corr_color, label=gene), max.overlaps = 100,size=2)



ggsave("Esitmate_vs_totalpath_AllGenes_LAMDAsigonly.pdf", p,  width = 14, height = 15, units = "cm")



```




```{r}

library(stringr)


Kinase_activity_positve_genes <- read_excel("Go_Kinase_Activity_Genes_Corr_PathVuln.xlsx", col_names = FALSE)

Kinase_activity_positve_genes <-as.data.frame(Kinase_activity_positve_genes)

Kinase_activity_positve_genes<-str_to_title(Kinase_activity_positve_genes[,1])

lamda_kinase_labels<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson



ind3<-lamda_kinase_labels$gene %in% Kinase_activity_positve_genes


lamda_kinase_labels<-lamda_kinase_labels[ind3,]

write.csv(lamda_kinase_labels,"LAMDA_kinases_Vuln_CorrValues.csv")






DE_Lamda_Kinase_Values<-LAMDA_Signature_Mouse[LAMDA_Signature_Mouse$Feature  %in% lamda_kinase_labels$gene,]
write.csv(DE_Lamda_Kinase_Values,"DE_Lamda_Kinase_Values.csv")

DE_Lamda_Kinase_Values$gene<-DE_Lamda_Kinase_Values$Feature



lamda_corrleation_merge<-merge(lamda_kinase_labels,DE_Lamda_Kinase_Values,by="gene")

write.csv(lamda_corrleation_merge,"lamda_corrleation_merge.csv")

  
```




```{r}

#read in geneset data from lamda paper
geneset_data_Mouse <- readRDS("~/Henderson_Lab/Pangea_Vulnerability/Pangea_Vulnerability_1_3_6_9_MPI_Model/geneset_data_Mouse.rds")


#create a plot that's a flat line of the correlation values of the gene correlation to vulnerability

total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color<-NA

# ind_mito<-grep(".*mito.*", geneset_data_Mouse@featureData@data[["GeneSet"]])
# geneset_data_Mouse@featureData@data[["GeneSet"]][ind_mito]
# 
# geneset_data_Mouse@featureData@data[["TargetIds"]][ind_mito[2]]





ind_kinases<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% Kinase_activity_positve_genes

total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_kinases]<-"Kinase"
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size<-log(1/total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$p_fdr)


kinases<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_kinases,]





p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  #theme(legend.position = "none")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray"))+
    geom_point(data=kinases,aes(x = r, y = 0, color=color, size=kinases$size),alpha=0.6, shape=16)+
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
  

p

ggsave("Kinase_correlation_highlight.pdf", p, width = 14, height = 10, units = "cm")
```





Now do with full set 
```{r}


Kinase_Activity_Full_Set <- read_excel("Kinase_Activity_Full_Set.xlsx")

Kinase_Activity_Full_Set <-unique(Kinase_Activity_Full_Set)

ind_kinases<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% Kinase_Activity_Full_Set$Gene

total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_kinases]<-"Kinase Activity"
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size<-log(1/total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$p_fdr)


kinases<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_kinases,]





p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  #theme(legend.position = "none")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Kinase Activity"="red"))+
    geom_point(data=kinases,aes(x = r, y = 0, color=color, size=kinases$size),alpha=0.6, shape=16)+
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
  

p

ggsave("Kinase_full_set_correlation_highlight.pdf", p, width = 14, height = 10, units = "cm")
```
















```{r}
library(stringr)


ind_synap<-grep(".*synap.*", geneset_data_Mouse@featureData@data[["GeneSet"]])
geneset_data_Mouse@featureData@data[["GeneSet"]][ind_synap]
excite_gene<-geneset_data_Mouse@featureData@data[["TargetIds"]][ind_synap[3]]
excite_gene<-str_split(excite_gene, ";")
excite_gene<-excite_gene[[1]]


ind_excite<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% excite_gene

total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_excite]<-"Excitatory"

excite<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_excite,]


p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  #theme(legend.position = "none")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange"))+
  geom_point(data=excite,aes(x = r, y = 0, color=color, size=excite$size),alpha=0.6, shape=16)+
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
p

ggsave("Excitatory_Synapse_correlation_highlight.pdf", p, width = 14, height = 10, units = "cm")

```





```{r}

ind_synap<-grep(".*synap.*", geneset_data_Mouse@featureData@data[["GeneSet"]])
geneset_data_Mouse@featureData@data[["GeneSet"]][ind_synap]
inhib_gene<-geneset_data_Mouse@featureData@data[["TargetIds"]][ind_synap[4]]
inhib_gene<-str_split(inhib_gene, ";")
inhib_gene<-inhib_gene[[1]]

ind_inhib<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% inhib_gene
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_inhib]<-"Inhibitory"
inhib<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_inhib,]


p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple"))+
  geom_point(data=inhib,aes(x = r, y = 0, color=color, size=inhib$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
p

ggsave("Inhibitory_Synapse_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")

```




```{r}

ind_synap<-grep(".*synap.*", geneset_data_Mouse@featureData@data[["GeneSet"]])
geneset_data_Mouse@featureData@data[["GeneSet"]][ind_synap]
dopa_gene<-geneset_data_Mouse@featureData@data[["TargetIds"]][ind_synap[2]]
dopa_gene<-str_split(dopa_gene, ";")
dopa_gene<-dopa_gene[[1]]

ind_dopa<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% dopa_gene
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_dopa]<-"Dopaminergic"
dopa<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_dopa,]


p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Dopaminergic"="blue"))+
  geom_point(data=dopa,aes(x = r, y = 0, color=color, size=dopa$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
p

ggsave("Dopaminergic_Synapse_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")

  
```


```{r}


#manually read in the kegg pathway oxidativve phosphorylation

OxPhos_Geneset_genes <- readRDS("~/Henderson_Lab/Pangea_Vulnerability/Pangea_Vulnerability_1_3_6_9_MPI_Model/OxPhos_Geneset_genes.rds")

ind_oxphos<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% OxPhos_Geneset_genes
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_oxphos]<-"Oxidative Phosphorylation"
ox<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_oxphos,]


p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green"))+
  geom_point(data=ox,aes(x = r, y = 0, color=color, size=ox$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
p

ggsave("Oxidative_Phosphorylation_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")



```






```{r}


LAMDA_NeuN<-LAMDA_signif[LAMDA_signif$Estimate<0,]
LAMDA_pSyn<-LAMDA_signif[LAMDA_signif$Estimate>0,]

ind_NeuN<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% LAMDA_NeuN$Feature
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_NeuN]<-"LAMDA NeuN"
NeuN<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_NeuN,]

ind_psyn<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% LAMDA_pSyn$Feature
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_psyn]<-"LAMDA pSyn"
psyn<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_psyn,]

LAMDA<-rbind(NeuN,psyn)



p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1"))+
  geom_point(data=LAMDA,aes(x = r, y = 0, color=color, size=LAMDA$size),alpha=0.2, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
p


ggsave("LAMDA_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")



p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1"))+
  geom_point(data=NeuN,aes(x = r, y = 0, color=color, size=NeuN$size),alpha=0.2, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
p

ggsave("LAMDA_NeuNonly_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")


p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1"))+
  geom_point(data=psyn,aes(x = r, y = 0, color=color, size=psyn$size),alpha=0.4, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
p

ggsave("LAMDA_pSynOnly_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")

```



```{r}

ER_upr_Genes <- readRDS("~/Henderson_Lab/Pangea_Vulnerability/Pangea_Vulnerability_1_3_6_9_MPI_Model/ER_upr_Genes.rds")

ind_ER<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% ER_upr_Genes
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_ER]<-"Endoplasmic Reticulum Unfolded Protein Response"
ER<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_ER,]

p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1",
                                "Endoplasmic Reticulum Unfolded Protein Response"="brown"))+
  geom_point(data=ER,aes(x = r, y = 0, color=color, size=ER$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))


p


ggsave("ER_UPR_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")



```


```{r}

library(stringr)

ind_RNA<-grep(".*RNA.*", geneset_data_Mouse@featureData@data[["GeneSet"]])
geneset_data_Mouse@featureData@data[["GeneSet"]][ind_RNA]
RNA_gene<-geneset_data_Mouse@featureData@data[["TargetIds"]][ind_RNA[11]]
RNA_gene<-str_split(RNA_gene, ";")
RNA_gene<-RNA_gene[[1]]

ind_RNA<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% RNA_gene
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_RNA]<-"RNA binding proteins (RBPs)"
RNA<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_RNA,]



p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1",
                                "Endoplasmic Reticulum Unfolded Protein Response"="brown",
                                "RNA binding proteins (RBPs)"="violet"))+
  geom_point(data=RNA,aes(x = r, y = 0, color=color, size=RNA$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))


p


ggsave("RNA_binding_proteins_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")



```


```{r}

#this code does not pull all the genes in the geneset but rather those that are in the lamda signature
ind_comp<-grep(".*Comple.*", geneset_data_Mouse@featureData@data[["GeneSet"]])
geneset_data_Mouse@featureData@data[["GeneSet"]][ind_comp]
comp_gene<-geneset_data_Mouse@featureData@data[["TargetIds"]][ind_comp[4]]
comp_gene<-str_split(comp_gene, ";")
comp_gene<-comp_gene[[1]]



#to pull all the genes in the geneset we use the pathways app than load that geneset
 Complement_Coagulation_Cascade <- readRDS("~/Henderson_Lab/Pangea_Vulnerability/Pangea_Vulnerability_1_3_6_9_MPI_Model/Complement_Coagulation_Cascade.rds")

ind_comp<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% Complement_Coagulation_Cascade
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_comp]<-"Complement and coagulation cascades"
comp<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_comp,]



p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1",
                                "Endoplasmic Reticulum Unfolded Protein Response"="brown",
                                "RNA binding proteins (RBPs)"="violet",
                                "Complement and coagulation cascades"="cyan"))+
  geom_point(data=comp,aes(x = r, y = 0, color=color, size=comp$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))


p


ggsave("Complement_Coagulation_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")




ind_comp<-grep(".*Comple.*", geneset_data_Mouse@featureData@data[["GeneSet"]])
geneset_data_Mouse@featureData@data[["GeneSet"]][ind_comp]
comp_gene<-geneset_data_Mouse@featureData@data[["TargetIds"]][ind_comp[5]]
comp_gene<-str_split(comp_gene, ";")
comp_gene<-comp_gene[[1]]

ind_comp<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% comp_gene
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_comp]<-"Complex-I assembly factors"
comp<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_comp,]



p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1",
                                "Endoplasmic Reticulum Unfolded Protein Response"="brown",
                                "RNA binding proteins (RBPs)"="violet",
                                "Complement and coagulation cascades"="cyan",
                                "Complex-I assembly factors"= "greenyellow"))+
  geom_point(data=comp,aes(x = r, y = 0, color=color, size=comp$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))


p


ggsave("Complex_I_assembly_factors_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")




```


Lets to PD causative genes
```{r}

PD_Genes <-c("SNCA", "PRKN", "UCHL1", "PINK1", "PARK7", "LRRK2", "ATP13A2", "GIGYF2", "HTRA2", "PLA2G6", "FBX07", "VPS35", "EIF4G1", "DNAJC6", "SYNJ1","DNAJC13", "CHCHD2", "VPS13C")
PD_Genes<-str_to_title(PD_Genes)
ind_PD<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% PD_Genes
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_PD]<-"Parkinson's Disease Causative Genes"
PD<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_PD,]


p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "Parkinson's Disease Causative Genes"="yellow3"))+
  geom_point(data=PD,aes(x = r, y = 0, color=color, size=PD$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
p

PD$gene

ggsave("PD_Causative_Genes_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")



```
```{r}
Nalls_2019_META5_GWAS <- read_excel("Nalls_2019_META5_GWAS.xlsx")

Gwas_Genes <-Nalls_2019_META5_GWAS$Nearest_Gene
Gwas_Genes<-str_to_title(Gwas_Genes)
ind_gwas<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% Gwas_Genes
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_gwas]<-"PD GWAS Genes"
gwas<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_gwas,]


p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "Parkinson's Disease Causative Genes"="yellow3",
                                "PD GWAS Genes"="blue3"))+
  geom_point(data=gwas,aes(x = r, y = 0, color=color, size=gwas$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))
  
p

gwas$gene

ggsave("PD_GWAS_Genes_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")



```

Lets get IOn channels
```{r}

Ion_Channel_Kegg_Pathway <- read_excel("Ion_Channel_Kegg_Pathway.xlsx",col_names = FALSE)
ion_gene<-Ion_Channel_Kegg_Pathway$...1
ind_ion<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% ion_gene
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_ion]<-"Ion Channels"
ion<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_ion,]



p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1",
                                "Endoplasmic Reticulum Unfolded Protein Response"="brown",
                                "RNA binding proteins (RBPs)"="violet",
                                "Complement and coagulation cascades"="cyan",
                                "Complex-I assembly factors"= "greenyellow",
                                "Ion Channels"="yellow"))+
  geom_point(data=ion,aes(x = r, y = 0, color=color, size=ion$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))


p


ggsave("Ion_Channels_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")



```





Lets do cell type genes

```{r}


library(ggrepel)
cell_types<- c("CUX2","EPHA6","RASGRF2","TMEM178B","CA10","FAM19A1","RFX3","KCTD16","KIRREL3","NTRK3","IL1RAPL1","LRRTM4","SYN3","CUX1","THSD7A","CAMK2A","PRKCA","PAM","SIPA1L1","TMEM108","RGS6","PTK2B","MAPK4","CACNA2D1","RORB","PTPRT","CNTN5","UNC5D","KCNC2","MEF2C","RUNX1T1","KCTD16","PTPRK","SHISA9","CDH9","TENM3","SLIT3","AK5","PCSK2","RGS12","TMEM132D","ERC2","KCTD16","ZNF804B","SORBS2","CUX1","LSAMP","NTNG2","MGAT5","UNC5C","GNG2","GALNT14","GNAO1","CACNA1E","CPNE5","CADPS2","SFMBT2","TENM4","SYNPR","CACNA1B","GNB4","KLHL1","GSG1L","SLC24A4","NR4A2","SYT1","GPD2","MBOAT2","ZNF804A","ENOX1","CPNE4","NBEA","SPOCK3","CHRM2","1-Mar","CACNA1C","DSCAML1","TMEM178B","GRIA4","TRPS1","TMEM163","OPRK1","ALCAM","TESC","PTPRU","ZEB2","HS3ST4","DLC1","TLE4","PITPNC1","PDZRN4","SLC35F1","SYT6","NRP1","MCTP1","GARNL3","PRKCB","ATP2B1","FOXP2","XKR4","KIAA1217","PCDH11X","1-Mar","FUT9","NRXN1","CDH10","NFIA","HS3ST4","EPHA5","DLC1","TNIK","TLE4","MDGA2","TENM1","SLC1A2","NFIB","PITPNC1","MCTP1","NR4A2","ACVR2A","RYR3","GAS7","SLC35F1","KCNMB4","PKP4","FRMPD4","MMP16","RAB3B","SLC8A1","GSG1L","VAT1L","GRIK2","ADRA1A","TMTC2","CDH20","FAM19A1","NRP1","NTNG1","LPP","SLIT2","SLC26A4","BCL11B","NEBL","ROBO2","ESRRG","PPARGC1A","NTM","RAB3C","FAM135B","STK39","SULF2","NFIB","ARL15","ANO4","EPHA6","DSCAML1","KCNN2","CHST8","SH3RF1","HTR4","HCN1","PEX5L","TCERG1L","POU3F1","TFDP2","FAM189A1","TOX2","GRIA3","ROBO1","FLT3","HDAC9","FRMD4A","RYR3","NAV1","CABP1","RAVER2","BCL6","DAB1","RAPGEF5","NEFH","GPRIN3","FAT3","SORCS2","FAM126A","NLGN1","TOX","FEZF2","NEFM","TRPC4","CTTNBP2","CDS1","GRAMD1B","PCGF5","ASAP1","WWOX","CACNA1H","TSHZ2","SORCS2","DAB1","KCNIP1","SPON1","GRM8","ETV1","ADCY2","KCNT2","VWC2L","PRR16","SATB1","OLFM3","C8orf34","SH3RF3","BCL11B","TLE4","MGAT4C","CAMK2D","CDH11","GRM3","PAK7","DCC","TOX","SASH1","CPNE4","CHSY3","STRBP","NETO2","SLC1A2","PCDH17","GRIA4")

cell_types<- str_to_title(cell_types)

ind_celltype<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% cell_types
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_celltype]<-"Cell Type Marker Genes"
cell_type<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_celltype,]




p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1",
                                "Endoplasmic Reticulum Unfolded Protein Response"="brown",
                                "RNA binding proteins (RBPs)"="violet",
                                "Complement and coagulation cascades"="cyan",
                                "Complex-I assembly factors"= "greenyellow",
                                "Ion Channels"="yellow",
                                "Cell Type Marker Genes"="brown"))+
  geom_point(data=cell_type,aes(x = r, y = 0, color=color, size=cell_type$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))+
  geom_text_repel(data = subset(cell_type, abs(cell_type$r)> 0.4),aes(x = subset(cell_type$r, abs(cell_type$r)> 0.4),y=0, label=subset(cell_type$gene, abs(cell_type$r)> 0.4)), size=1, color="black", fontface="bold", min.segment.length = .01, box.padding = .1, lwd = .2, max.overlaps = 50, segment.size=0.1, force = 10, max.time = 3) 


p

ggsave("Cell_Type_Marker_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")

```















Let's do gene set enrichment on the correlation scores by gene

```{r}
# BiocManager::install("clusterProfiler", version = "3.8")
# BiocManager::install("pathview")
# BiocManager::install("enrichplot")
library(clusterProfiler)
library(enrichplot)
# we use ggplot2 to add x axis labels (ex: ridgeplot)
library(ggplot2)



```

```{r}
# reading in data from deseq2
df =total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson

# we want the log2 fold change 
original_gene_list <- df$r

# name the vector
names(original_gene_list) <- as.character(df$gene)

# omit any NA values 
gene_list<-na.omit(original_gene_list)

# sort the list in decreasing order (required for clusterProfiler)
gene_list = sort(gene_list, decreasing = TRUE)
```


```{r}

gse <- gseGO(geneList=gene_list, 
             ont ="ALL", 
             keyType = "SYMBOL", 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = "org.Mm.eg.db", 
             pAdjustMethod = "fdr")

```

```{r}

require(DOSE)
dotplot(gse, showCategory=10, split=".sign") + facet_grid(.~.sign)


```


```{r}

gse2<-pairwise_termsim(gse)
emapplot(gse2, showCategory = 10)

```

```{r}

# categorySize can be either 'pvalue' or 'geneNum'
cnetplot(gse, categorySize="pvalue", foldChange=gene_list, showCategory = 30)
```


```{r}

p<-ridgeplot(gse, showCategory = 600, fill="NES") + labs(x = "enrichment distribution", size=6) + 
  theme(axis.text.y =element_text(size=4),
        axis.text.x =element_text(size=4),
        plot.background = element_blank(),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  legend.key.size = unit(0.5,'cm'),
                  legend.text = element_text(size=5))
  


ggsave(p, file = "ridgeplot.pdf", width = 14, height = 125, units = "cm")



```




```{r}
gse@result[["Description"]]

```





Now do Kegg pathway enrichment

```{r}



if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("clusterProfiler")

BiocManager::install("enrichplot")

BiocManager::install("org.Mm.eg.db")

library(org.Mm.eg.db)

library(AnnotationDbi)
library(clusterProfiler)
library(enrichplot)
# we use ggplot2 to add x axis labels (ex: ridgeplot)
library(ggplot2)

gene_list2<-gene_list

gene_list2[,2]<-names(gene_list2)
write_csv(gene_list, "gene_list.csv")



library(org.Mm.eg.db)

##Toy example symbols:
sym = c("AKT3","CDH1")



gene_names<-names(gene_list)                     
                      
##Get the Entrez gene IDs associated with those symbols
EG_IDs = mget(gene_names, revmap(org.Mm.egSYMBOL),ifnotfound=NA)

names(EG_IDs)<-EG_IDs
##Then get the KEGG IDs associated with those entrez genes.
KEGG_IDs = mget(as.character(EG_IDs), org.Mm.egPATH,ifnotfound=NA)


names(gene_list)<-names(KEGG_IDs)


gse_Kegg <- gseKEGG(geneList=gene_list, 
             keyType = "kegg", 
             organism = "mmu",
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             pAdjustMethod = "fdr")


gse_Kegg2 <- gseKEGG(geneList=gene_list, 
             keyType = "kegg", 
             organism = "mmu",
             minGSSize = 1, 
             maxGSSize = 10000, 
             pvalueCutoff = 2, 
             verbose = TRUE, 
             pAdjustMethod = "fdr")




```

```{r}

require(DOSE)
dotplot(gse_Kegg, showCategory=10, split=".sign") + facet_grid(.~.sign)


```


```{r}

gse_Kegg_2<-pairwise_termsim(gse_Kegg)
emapplot(gse_Kegg_2, showCategory = 10)

```

```{r}

# categorySize can be either 'pvalue' or 'geneNum'
cnetplot(gse_Kegg, categorySize="pvalue", foldChange=gene_list, showCategory = 10)
```


```{r}

library(stringr)

gse_Kegg@result[["Description"]]<-gse_Kegg@result[["Description"]] %>% str_replace("- Mus.*", "")

p<-ridgeplot(gse_Kegg, showCategory = 600, fill="NES", ) + labs(x = "enrichment distribution", size=6) + 
  theme(axis.text.y =element_text(size=4),
        axis.text.x =element_text(size=6),
        plot.background = element_blank(),
                  panel.grid.major = element_blank(),
                  panel.grid.minor = element_blank(),
                  legend.key.size = unit(0.5,'cm'),
                  legend.text = element_text(size=5),
                  max.overlaps=500)+
  set_enrichplot_color(colors =  c("blue","white","red"), type = "fill")
  
  

  


ggsave(p, file = "ridgeplot_KeggEnrich.pdf", width = 5, height = 8, units = "in")



```

```{r}
gse_summtable<-c()
gse_summtable<-cbind(gse_Kegg2@result$Description, gse_Kegg2@result$NES,gse_Kegg2@result$setSize, gse_Kegg2@result$pvalue, gse_Kegg2@result$p.adjust, gse_Kegg2@result$enrichmentScore )

colnames(gse_summtable)<-c("Description", "NES", "setSize", "pvalue", "p.adjust", "enrichmentScore")

write.csv(gse_summtable, "gse_summtable.csv")

```



```{r}
gse_Kegg@result[["Description"]]

```



```{r}



vir_prot<-pathview(gene.data=gse_Kegg, pathway.id="mmu04061", species = "mmu")

vir_gene<-vir_prot[["plot.data.gene"]][["labels"]]


ind_vir<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% vir_gene
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_vir]<-"Viral protein interaction with cytokine and cytokine receptor"
vir<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_vir,]



p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1",
                                "Endoplasmic Reticulum Unfolded Protein Response"="brown",
                                "RNA binding proteins (RBPs)"="violet",
                                "Complement and coagulation cascades"="cyan",
                                "Complex-I assembly factors"= "greenyellow",
                                "Viral protein interaction with cytokine and cytokine receptor"="red"))+
  geom_point(data=vir,aes(x = r, y = 0, color=color, size=vir$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))


p


ggsave("Viral_Protein_interaction_with_cytokine_and_cytokine_receptor_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")

```



```{r}
vir_prot<-pathview(gene.data=gse_Kegg, pathway.id="hsa04137", species = "hsa")

vir_gene<-vir_prot[["plot.data.gene"]][["labels"]]


ind_vir<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$gene %in% vir_gene
total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$color[ind_vir]<-"Mitophagy"
vir<-total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson[ind_vir,]



p<-ggplot(data = total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson)  +
  geom_point(aes(x = r,y=0 ,size=total_pathAllGenesVulnerability_1_3_6_9_MPI_pearson$size, color="gray") ,alpha=0.1, shape=16)+  
  theme_minimal() +
  theme(legend.position = "right")+
   theme(axis.line = element_line(color='black'),
    plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  scale_color_manual(values = c("Kinase" = "red",
                                "NA"="gray",
                                "Excitatory"="orange",
                                "Inhibitory"="purple",
                                "Oxidative Phosphorylation"="green",
                                "LAMDA NeuN"= "dodgerblue2",
                                "LAMDA pSyn"= "firebrick1",
                                "Endoplasmic Reticulum Unfolded Protein Response"="brown",
                                "RNA binding proteins (RBPs)"="violet",
                                "Complement and coagulation cascades"="cyan",
                                "Complex-I assembly factors"= "greenyellow",
                                "Viral protein interaction with cytokine and cytokine receptor"="red",
                                "Mitophagy"="dodgerblue3"
                                ))+
  geom_point(data=vir,aes(x = r, y = 0, color=color, size=vir$size),alpha=0.6, shape=16)+ 
  theme(plot.title = element_text(size = 3, face = "bold"),
    legend.title=element_text(size=3), 
    legend.text=element_text(size=3),
    legend.key.size = unit(0.3,'cm'))


p


ggsave("Mitophagy_animal_correlation_highlight.pdf", p,  width = 14, height = 10, units = "cm")






```












Violin plots from Goralski et al 2024 aggregate vs non aggregate


```{r}


target_data <- readRDS("~/Henderson_Lab/Pangea_Vulnerability/Pangea_Vulnerability_1_3_6_9_MPI_Model/target_data.RDS")

results30<-LAMDA_Signature_Mouse

#define genes of interest
top_g<-c("Cdk9", "Nlk","Pak6", "Dckl1", "Prkca", "Ptk2","Ntrk2", "Ip6k2", "Camk4", "Itpka", "Pip4k2c", "Dgkz")



library(ggplot2)
library(tidyverse)
library(plyr)
#begin violin plotting
prop<-target_data@assayData$log_q
annots<-target_data@phenoData@data

segment<-"segment"

violin_df <- cbind(annots %>% dplyr::select(eval(segment)),
                  t(prop))
violin_df <- violin_df %>% tidyr::pivot_longer(cols=-c(1,2), names_to = "Feature", values_to = "Expression")

violin_p_df <- filter(results30, Gene %in% top_g)  
violin_p_df <- violin_p_df %>% tidyr::separate(col = Comparison, into=c("group1", "group2"), sep=" vs ")
violin_p_df$FDR <- signif(violin_p_df$FDR, 3)
violin_p_df$P <- signif(violin_p_df$P, 3)
violin_exp_max <- ddply(violin_df, .(Feature), summarize,
                        y.position=(max(Expression)*1.1)) # +1 for safe log2
violin_p_df <- base::merge(violin_p_df, violin_exp_max, by="Feature")

violin_df<-base::merge(violin_p_df, violin_df, by="Feature")

violin_df$FDR<-signif(violin_df$FDR, 3)

p <- ggplot(violin_df, 
            aes(x=segment, y=Expression, fill=segment)) + 
  geom_violin(alpha=0.2) +
  geom_jitter(width=0.1, height=0, size = 1) + 
  scale_fill_manual(values = c("blue", "red", "grey")) +
  facet_wrap(~Feature, scales = "free_y") +
  labs(x = eval(segment), y = "Expression (log q3 normalized counts)") +
  scale_y_continuous(expand = expansion(mult = 0.2)) +
  expand_limits(y=0)+
  theme_bw(base_size = 14) +
  theme( plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  guides(fill=guide_legend(title = eval(segment)))
p <- p + ggprism::add_pvalue(
  violin_p_df,
  label="FDR = {FDR}", label.size = 3.6,
  y.position = violin_p_df$y.position
) + theme(legend.position="bottom")


p

ggsave("violins_kinasesscreen_pvalues .pdf", p,  width = 14, height = 20, units = "cm")


#now lets make it all one graph

prop<-target_data@assayData$log_q
annots<-target_data@phenoData@data

segment<-"segment"

violin_df <- cbind(annots %>% dplyr::select(eval(segment)),
                  t(prop))
violin_df <- violin_df %>% tidyr::pivot_longer(cols=-c(1,2), names_to = "Feature", values_to = "Expression")

violin_p_df <- filter(results30, Feature %in% top_g)  
violin_p_df <- violin_p_df %>% tidyr::separate(col = Comparison, into=c("group1", "group2"), sep=" vs ")
violin_p_df$FDR <- signif(violin_p_df$FDR, 3)
violin_p_df$P <- signif(violin_p_df$P, 3)
violin_exp_max <- ddply(violin_df, .(Feature), summarize,
                        y.position=(max(Expression)*1.1)) # +1 for safe log2
violin_p_df <- base::merge(violin_p_df, violin_exp_max, by="Feature")

violin_df<-base::merge(violin_p_df, violin_df, by="Feature")

violin_df$FDR<-signif(violin_df$FDR, 3)



library(ggforce)
library(rstatix)
violin_p_df %>% add_xy_position(x = "Feature", dodge = 0.8)
  

p <- ggplot(violin_df, 
            aes(x=Feature, y=Expression, fill=segment)) + 
  geom_violin(alpha=0.2, size=0.5) +
  geom_sina(width=0.1, height=0, size = 0.01 ) + 
  scale_fill_manual(values = c("blue", "red", "grey")) +
  #facet_wrap(~Feature, scales = "free_y") +
  labs(x = eval(segment), y = "Expression (log q3 normalized counts)") +
  scale_y_continuous(expand = expansion(mult = 0.2)) +
  expand_limits(y=0)+
  theme_bw(base_size = 8) +
  theme( plot.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank())+
  guides(fill=guide_legend(title = eval(segment)))


p



ggsave("violins_kinasescreen.pdf", p,  width = 14, height = 4.5, units = "cm")











```





